package segment_test

import (
	"context"
	"testing"

	"github.com/stretchr/testify/assert"
	"github.com/uswitch/terraform-provider-segment/segment"
)

func TestResourceInstanceStateUpgradeV1(t *testing.T) {
	v1 := map[string]interface{}{
		"import_from": []interface{}{
			"{\"global\":{\"$schema\":\"http://json-schema.org/draft-07/schema#\",\"type\":\"object\",\"properties\":{\"context\":{},\"properties\":{},\"traits\":{}}},\"events\":[{\"name\":\"Form Submitted\",\"description\":\"fired when a user submits a form.\",\"rules\":{\"$schema\":\"http://json-schema.org/draft-07/schema#\",\"type\":\"object\",\"properties\":{\"context\":{},\"properties\":{\"required\":[\"form_id\"],\"type\":\"object\",\"properties\":{\"form_id\":{\"description\":\"the ID of the form\",\"type\":[\"string\"]},\"name\":{\"description\":\"the name of the form\",\"type\":[\"string\",\"null\"]},\"form_orientation\":{\"description\":\"orientation of the form\",\"type\":[\"integer\"]}}},\"traits\":{}},\"required\":[\"properties\"]},\"version\":1},{\"name\":\"Button Pressed\",\"description\":\"fired when a user submits a form.\",\"rules\":{\"$schema\":\"http://json-schema.org/draft-07/schema#\",\"type\":\"object\",\"properties\":{\"context\":{},\"properties\":{\"required\":[\"form_id\"],\"type\":\"object\",\"properties\":{\"form_id\":{\"description\":\"the ID of the form\",\"type\":[\"string\"]},\"name\":{\"description\":\"the name of the form\",\"type\":[\"string\",\"null\"]},\"form_orientation\":{\"description\":\"orientation of the form\",\"type\":[\"integer\"]}}},\"traits\":{}},\"required\":[\"properties\"]},\"version\":1}],\"group\":{\"$schema\":\"http://json-schema.org/draft-07/schema#\",\"type\":\"object\",\"properties\":{\"context\":{},\"properties\":{},\"traits\":{}}},\"identify\":{\"$schema\":\"http://json-schema.org/draft-07/schema#\",\"type\":\"object\",\"properties\":{\"context\":{},\"properties\":{},\"traits\":{}}}}",
			"{\"global\":{\"$schema\":\"http://json-schema.org/draft-07/schema#\",\"type\":\"object\",\"properties\":{\"context\":{},\"properties\":{},\"traits\":{}}},\"events\":[{\"name\":\"Broadband Form Submitted\",\"description\":\"fired when a user submits a form.\",\"rules\":{\"$schema\":\"http://json-schema.org/draft-07/schema#\",\"type\":\"object\",\"properties\":{\"context\":{},\"properties\":{\"required\":[\"form_id\"],\"type\":\"object\",\"properties\":{\"form_id\":{\"description\":\"the ID of the form\",\"type\":[\"string\"]},\"name\":{\"description\":\"the name of the form\",\"type\":[\"string\",\"null\"]},\"form_orientation\":{\"description\":\"orientation of the form\",\"type\":[\"integer\"]}}},\"traits\":{}},\"required\":[\"properties\"]},\"version\":1},{\"name\":\"Broadband Button Pressed\",\"description\":\"fired when a user submits a form.\",\"rules\":{\"$schema\":\"http://json-schema.org/draft-07/schema#\",\"type\":\"object\",\"properties\":{\"context\":{},\"properties\":{\"required\":[\"form_id\"],\"type\":\"object\",\"properties\":{\"form_id\":{\"description\":\"the ID of the form\",\"type\":[\"string\"]},\"name\":{\"description\":\"the name of the form\",\"type\":[\"string\",\"null\"]},\"form_orientation\":{\"description\":\"orientation of the form\",\"type\":[\"integer\"]}}},\"traits\":{}},\"required\":[\"properties\"]},\"version\":1}],\"group\":{\"$schema\":\"http://json-schema.org/draft-07/schema#\",\"type\":\"object\",\"properties\":{\"context\":{},\"properties\":{},\"traits\":{}}},\"identify\":{\"$schema\":\"http://json-schema.org/draft-07/schema#\",\"type\":\"object\",\"properties\":{\"context\":{},\"properties\":{},\"traits\":{}}}}",
		},
	}
	v2Expected := map[string]interface{}{
		"import_from": "[{\"global\":{\"$schema\":\"http://json-schema.org/draft-07/schema#\",\"type\":\"object\",\"properties\":{\"context\":{},\"properties\":{},\"traits\":{}}},\"events\":[{\"name\":\"Form Submitted\",\"description\":\"fired when a user submits a form.\",\"rules\":{\"$schema\":\"http://json-schema.org/draft-07/schema#\",\"type\":\"object\",\"properties\":{\"context\":{},\"properties\":{\"required\":[\"form_id\"],\"type\":\"object\",\"properties\":{\"form_id\":{\"description\":\"the ID of the form\",\"type\":[\"string\"]},\"name\":{\"description\":\"the name of the form\",\"type\":[\"string\",\"null\"]},\"form_orientation\":{\"description\":\"orientation of the form\",\"type\":[\"integer\"]}}},\"traits\":{}},\"required\":[\"properties\"]},\"version\":1},{\"name\":\"Button Pressed\",\"description\":\"fired when a user submits a form.\",\"rules\":{\"$schema\":\"http://json-schema.org/draft-07/schema#\",\"type\":\"object\",\"properties\":{\"context\":{},\"properties\":{\"required\":[\"form_id\"],\"type\":\"object\",\"properties\":{\"form_id\":{\"description\":\"the ID of the form\",\"type\":[\"string\"]},\"name\":{\"description\":\"the name of the form\",\"type\":[\"string\",\"null\"]},\"form_orientation\":{\"description\":\"orientation of the form\",\"type\":[\"integer\"]}}},\"traits\":{}},\"required\":[\"properties\"]},\"version\":1}],\"group\":{\"$schema\":\"http://json-schema.org/draft-07/schema#\",\"type\":\"object\",\"properties\":{\"context\":{},\"properties\":{},\"traits\":{}}},\"identify\":{\"$schema\":\"http://json-schema.org/draft-07/schema#\",\"type\":\"object\",\"properties\":{\"context\":{},\"properties\":{},\"traits\":{}}}}, {\"global\":{\"$schema\":\"http://json-schema.org/draft-07/schema#\",\"type\":\"object\",\"properties\":{\"context\":{},\"properties\":{},\"traits\":{}}},\"events\":[{\"name\":\"Broadband Form Submitted\",\"description\":\"fired when a user submits a form.\",\"rules\":{\"$schema\":\"http://json-schema.org/draft-07/schema#\",\"type\":\"object\",\"properties\":{\"context\":{},\"properties\":{\"required\":[\"form_id\"],\"type\":\"object\",\"properties\":{\"form_id\":{\"description\":\"the ID of the form\",\"type\":[\"string\"]},\"name\":{\"description\":\"the name of the form\",\"type\":[\"string\",\"null\"]},\"form_orientation\":{\"description\":\"orientation of the form\",\"type\":[\"integer\"]}}},\"traits\":{}},\"required\":[\"properties\"]},\"version\":1},{\"name\":\"Broadband Button Pressed\",\"description\":\"fired when a user submits a form.\",\"rules\":{\"$schema\":\"http://json-schema.org/draft-07/schema#\",\"type\":\"object\",\"properties\":{\"context\":{},\"properties\":{\"required\":[\"form_id\"],\"type\":\"object\",\"properties\":{\"form_id\":{\"description\":\"the ID of the form\",\"type\":[\"string\"]},\"name\":{\"description\":\"the name of the form\",\"type\":[\"string\",\"null\"]},\"form_orientation\":{\"description\":\"orientation of the form\",\"type\":[\"integer\"]}}},\"traits\":{}},\"required\":[\"properties\"]},\"version\":1}],\"group\":{\"$schema\":\"http://json-schema.org/draft-07/schema#\",\"type\":\"object\",\"properties\":{\"context\":{},\"properties\":{},\"traits\":{}}},\"identify\":{\"$schema\":\"http://json-schema.org/draft-07/schema#\",\"type\":\"object\",\"properties\":{\"context\":{},\"properties\":{},\"traits\":{}}}}]",
	}
	result, err := segment.TpV1V2Upgrader().Upgrade(context.Background(), v1, nil)
	assert.NoError(t, err)

	assert.JSONEq(t, v2Expected["import_from"].(string), result["import_from"].(string))
}
